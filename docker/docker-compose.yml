version: '3'

# inspired by Cooper's IGVC selfdrive docker structure! https://github.com/CooperUnion/selfdrive.git

services:
  master:
    build: master/.
    container_name: master
    tty: true
    privileged: true
    environment:
        - 'ROS_HOSTNAME=master'
        - 'ROS_MASTER_URI=http://master:11311'
        - 'DISPLAY=$DISPLAY'
        - 'QT_X11_NO_MITSHM=1'
    ports:
        - '11311:11311'
    volumes:
        - '/tmp/.X11-unix:/tmp/.X11-unix'
    restart: unless-stopped
    command: stdbuf -o L roscore

  tello-ros:
    build: tello-ros/.
    container_name: tello-ros
    tty: true
    # network_mode: host
    privileged: true
    environment:
        - 'ROS_HOSTNAME=tello-ros'
        - 'ROS_MASTER_URI=http://master:11311'
        - 'DISPLAY=$DISPLAY'
        - 'QT_X11_NO_MITSHM=1'
    volumes:
        - '/tmp/.X11-unix:/tmp/.X11-unix'
        - './tello-ros:/app/ros_ws/src'
        # - './noetic-fast-planner:/app/ros_ws/src'
        # - './Fast-Planner:/app/ros_ws/src/Fast-Planner'
        - './Fast-Planner-Noetic:/app/ros_ws/src/Fast-Planner'
        - './ORB-SLAM3/ORB_SLAM3_NOETIC:/app/ros_ws/src/orbslam3'
        - './drone_controller:/app/ros_ws/src/drone_controller'
        - './packnet_sfm_ros:/app/packnet_ws/src/packnet_sfm_ros'
        # - '/usr/lib/cuda:/usr/lib/cuda'
        - '/dev/input/js0:/dev/input/js0'
    depends_on:
        - master
    ports:
        - 8889:8889/udp
        - 8890:8890/udp
        - 11111:11111/udp
        - 6038:6038/udp
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities:
                - gpu
                - utility # nvidia-smi
                - compute # CUDA. Required to avoid "CUDA version: N/A"
                - video   # NVDEC/NVENC. For instance to use a hardware accelerated ffmpeg. Skip it if you don't need it

  packnet:
    build: packnet_sfm_ros/.
    container_name: packnet
    tty: true
    privileged: true
    environment:
        - 'ROS_HOSTNAME=packnet'
        - 'ROS_MASTER_URI=http://master:11311'
        - 'DISPLAY=$DISPLAY'
        - 'QT_X11_NO_MITSHM=1'
    volumes:
        - '/tmp/.X11-unix:/tmp/.X11-unix'
        - './packnet_sfm_ros:/app/packnet_ws/src/packnet_sfm_ros'
    depends_on:
        - master
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]


#   orbslam3:
#     build: ORB-SLAM3/.
#     container_name: orbslam3
#     tty: true
#     network_mode: host
#     privileged: true # I added privileged to get xhost working, though I don't think this is the direct solution. export DISPLAY=:0, xhost +si:localuser:root business.. etc etc
#     environment:
#         - 'ROS_HOSTNAME=orbslam3'
#         - 'ROS_MASTER_URI=http://master:11311'
#         - 'DISPLAY=$DISPLAY'
#         - 'QT_X11_NO_MITSHM=1'
#     volumes:
#         - '/tmp/.X11-unix:/tmp/.X11-unix'
#         - './ORB-SLAM3/ORB_SLAM3_NOETIC:/app/ros_ws/src/orbslam3'
#     depends_on:
#         - master
  

## SCRATCH THIS DOING EVERYTHING IN ONE CONTAINER LOL ##

#   tellopy:
#     build: TelloPy/.
#     container_name: tellopy
#     tty: true
#     network_mode: host
#     privileged: true
#     environment:
#         - 'ROS_HOSTNAME=tellopy'
#         - 'ROS_MASTER_URI=http://master:11311'
#         - 'DISPLAY=$DISPLAY'
#         - 'QT_X11_NO_MITSHM=1'
#     volumes:
#         - '/tmp/.X11-unix:/tmp/.X11-unix'
#         - './TelloPy:/app/ros_ws/src/TelloPy'
#     depends_on:
#         - master



  
#   rviz:
#     build: rviz/.
#     container_name: rviz
#     tty: true
#     privileged: true
#     environment:
#         - 'ROS_HOSTNAME=rviz'
#         - 'ROS_MASTER_URI=http://master:11311'
#         - 'DISPLAY=$DISPLAY'
#         - 'QT_X11_NO_MITSHM=1'
#     volumes:
#         - '/tmp/.X11-unix:/tmp/.X11-unix'
#     depends_on:
#         - master